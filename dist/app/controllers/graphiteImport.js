/*! grafana - v1.8.0 - 2014-09-08
 * Copyright (c) 2014 Torkel Ã–degaard; Licensed Apache License */

define(["angular","app","lodash"],function(a,b,c){var d=a.module("grafana.controllers");d.controller("GraphiteImportCtrl",["$scope","$rootScope","$timeout","datasourceSrv",function(b,d,e,f){function g(d,e){var f,g,h,i=2,j=300;f={title:"",panels:[],height:j},g=a.copy(f);var k=a.copy(b.dashboard);k.rows=[],k.title=d.name,k.rows.push(g),c.each(d.graphs,function(b){g.panels.length===i&&(g=a.copy(f),k.rows.push(g)),h={type:"graphite",span:12/i,title:b[1].title,targets:[],datasource:e},c.each(b[1].target,function(a){h.targets.push({target:a})}),g.panels.push(h)}),b.emitAppEvent("setup-dashboard",k),b.dismiss()}b.init=function(){b.datasources=f.getMetricSources(),b.setDatasource(null)},b.setDatasource=function(a){return b.datasource=f.get(a),b.datasource?void 0:void(b.error="Cannot find datasource "+a)},b.listAll=function(a){delete b.error,b.datasource.listDashboards(a).then(function(a){b.dashboards=a}).then(null,function(a){b.error=a.message||"Error while fetching list of dashboards"})},b.import=function(a){delete b.error,b.datasource.loadDashboard(a).then(function(a){if(!a.data||!a.data.state)throw{message:"no dashboard state received from graphite"};g(a.data.state,b.datasource.name)}).then(null,function(a){b.error=a.message||"Failed to import dashboard"})}}])});