/*! grafana - v1.8.0 - 2014-09-08
 * Copyright (c) 2014 Torkel Ã–degaard; Licensed Apache License */

define(["angular","lodash","config","../services/graphite/gfunc","../services/graphite/parser"],function(a,b,c,d,e){var f=a.module("grafana.controllers"),g=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O"];f.controller("GraphiteTargetCtrl",["$scope","$sce","templateSrv",function(c,f,h){function i(){c.functions=[],c.segments=[],c.showTextEditor=!1,delete c.parserError;var a=new e(c.target.target),b=a.getAst();if(null===b)return void m(0);if("error"===b.type)return c.parserError=b.message+" at position: "+b.pos,void(c.showTextEditor=!0);try{k(b)}catch(d){console.log("error parsing target:",d.message),c.parserError=d.message,c.showTextEditor=!0}m(c.segments.length-1)}function j(a,b,c,d){d&&(c=Math.max(c-1,0)),a.params[c]=b}function k(a,e,f){if(null===a)return null;switch(a.type){case"function":var g=d.createFuncInstance(a.name,{withDefaultParams:!1});b.each(a.params,function(a,b){k(a,g,b)}),g.updateText(),c.functions.push(g);break;case"series-ref":j(e,a.value,f,c.segments.length>0);break;case"string":case"number":if(f-1>=e.def.params.length)throw{message:"invalid number of parameters to method "+e.def.name};j(e,a.value,f,!0);break;case"metric":if(c.segments.length>0){if(1!==c.segments[0].length)throw{message:"Multiple metric params not supported, use text editor."};j(e,a.segments[0].value,f,!0);break}c.segments=b.map(a.segments,function(a){return new p(a)})}}function l(a){var d=c.segments.slice(0,a);return b.reduce(d,function(a,b){return a?a+"."+b.value:b.value},"")}function m(a){if(0===a)return void c.segments.push(new p("select metric"));var b=l(a+1);return c.datasource.metricFindQuery(b).then(function(d){if(0===d.length)return void(""!==b&&(c.segments=c.segments.splice(0,a),c.segments.push(new p("select metric"))));if(d[0].expandable){if(c.segments.length!==a)return m(a+1);c.segments.push(new p("select metric"))}}).then(null,function(a){c.parserError=a.message||"Failed to issue metric query"})}function n(a){b.each(c.segments,function(b,c){b.focus=a===c})}function o(a,b){return b.render(a)}function p(a){return"*"===a||"*"===a.value?(this.value="*",this.html=f.trustAsHtml('<i class="icon-asterisk"><i>'),void(this.expandable=!0)):b.isString(a)?(this.value=a,void(this.html=f.trustAsHtml(this.value))):(this.value=a.value,this.type=a.type,this.expandable=a.expandable,void(this.html=f.trustAsHtml(h.highlightVariablesAsHtml(this.value))))}c.init=function(){c.target.target=c.target.target||"",c.targetLetter=g[c.$index],i()},c.getAltSegments=function(a){c.altSegments=[];var d=0===a?"*":l(a)+".*";return c.datasource.metricFindQuery(d).then(function(a){c.altSegments=b.map(a,function(a){return new p({value:a.text,expandable:a.expandable})}),b.each(h.variables,function(a){c.altSegments.unshift(new p({type:"template",value:"$"+a.name,expandable:!0}))}),c.altSegments.unshift(new p("*"))}).then(null,function(a){c.parserError=a.message||"Failed to issue metric query"})},c.segmentValueChanged=function(a,b){return delete c.parserError,c.functions.length>0&&c.functions[0].def.fake&&(c.functions=[]),a.expandable?m(b+1).then(function(){n(b+1),c.targetChanged()}):(c.segments=c.segments.splice(0,b+1),n(b+1),void c.targetChanged())},c.targetTextChanged=function(){i(),c.$parent.get_data()},c.targetChanged=function(){if(!c.parserError){var a=c.target.target,d=l(c.segments.length);c.target.target=b.reduce(c.functions,o,d),c.target.target!==a&&c.$parent.get_data()}},c.removeFunction=function(a){c.functions=b.without(c.functions,a),c.targetChanged()},c.addFunction=function(a){var b=d.createFuncInstance(a,{withDefaultParams:!0});b.added=!0,c.functions.push(b),c.moveAliasFuncLast(),c.smartlyHandleNewAliasByNode(b),1===c.segments.length&&"select metric"===c.segments[0].value&&(c.segments=[]),!b.params.length&&b.added&&c.targetChanged()},c.moveAliasFuncLast=function(){var a=b.find(c.functions,function(a){return"alias"===a.def.name||"aliasByNode"===a.def.name||"aliasByMetric"===a.def.name});a&&(c.functions=b.without(c.functions,a),c.functions.push(a))},c.smartlyHandleNewAliasByNode=function(a){if("aliasByNode"===a.def.name)for(var b=0;b<c.segments.length;b++)if(c.segments[b].value.indexOf("*")>=0)return a.params[0]=b,a.added=!1,void c.targetChanged()},c.toggleMetricOptions=function(){c.panel.metricOptionsEnabled=!c.panel.metricOptionsEnabled,c.panel.metricOptionsEnabled||delete c.panel.cacheTimeout},c.duplicate=function(){var b=a.copy(c.target);c.panel.targets.push(b)}}]),f.directive("focusMe",["$timeout","$parse",function(a,b){return{link:function(c,d,e){var f=b(e.focusMe);c.$watch(f,function(b){b===!0&&a(function(){d[0].focus()})})}}}])});